<script>

	//select2 
	function initializeSelect2() {
		if ($.fn.select2) {
			$('.select2').select2({
				language: {
					noResults: function () {
						return "نتیجه ای یافت نشد"; // Your custom message
					}
				},
			});
		}
	}

	$(document).ready(function () {

		// choice field seach box
		initializeSelect2();
		updateSortHeaders();

		function displayLoading() {
			$('.loading-container').animate({ opacity: 1 }, 'fast', function () {
				$('.loading-container').css('visibility', 'visible');
			});
		}
		function hideLoading() {
			$('.loading-container').animate({ opacity: 0 }, 'fast', function () {
				$('.loading-container').css('visibility', 'hidden');
			})
		}

		async function loadPage(pageNumber, url) {

			console.log("loadpage", pageNumber)

			// search by text
			textSearch = ""
			searchInput = document.getElementById('searchInput')

			if (searchInput != null) {
				textSearch = searchInput.value
			}

			var params = {
				"page": pageNumber,
				"search": textSearch,
			};

			// search by date filter
			if ($("#from_date").length == 1) {
				//console.log($("#from_date").val())
				params.from_date = $("#from_date").val();
			}
			if ($("#to_date").length == 1) {
				//console.log($("#to_date").val())
				params.to_date = $("#to_date").val();
			}

			var queryString = Object.keys(params).map(key => key + '=' + encodeURIComponent(params[key])).join('&');
			url += '?' + queryString;

			displayLoading();
			await fetch(url)
				.then(response => response.text())
				.then(html => {
					// Create a temporary container element
					var container = document.createElement('div');
					container.innerHTML = html;
					// Find the <main class="content"> element from the fetched HTML
					var fetchedMain = container.querySelector('#listitems');
					// Find the existing <main class="content"> element in the current page
					var existingMain = document.getElementById('listitems');
					// Replace the existing <main> element with the fetched one
					existingMain.replaceWith(fetchedMain);
					console.log("fetched")
					updateSortHeaders()
					hideLoading()
					// triger the new event 
					const event = new CustomEvent('onPageNumberChanged', { detail: { "pageNumber": pageNumber } });
					document.dispatchEvent(event);
				})
				.catch(error => {
					hideLoading();
				});
		}
		// Attach click event listener to a parent element
		$(document).on('click', '[name="index-page-button"]', function (event) {
			event.preventDefault();
			var page_number = parseInt($(this).text());
			loadPage(page_number, load_page_url);
		});

		$(document).on('click', '#first-page-button', function (event) {
			event.preventDefault();
			var page_number = 1
			loadPage(page_number, load_page_url);
		});
		$(document).on('click', '#previous-page-button', function (event) {
			event.preventDefault();
			var page_number = getActiveCurrentPage()
			loadPage(page_number - 1, load_page_url);
		});

		$(document).on('click', '#next-page-button', function (event) {
			event.preventDefault();
			var page_number = getActiveCurrentPage()
			loadPage(page_number + 1, load_page_url);
		});

		$(document).on('click', '#last-page-button', function (event) {
			event.preventDefault();
			var activeLinkText = getActiveCurrentPage()
			var page_number = "{{ page.paginator.num_pages }}"
			loadPage(page_number, load_page_url);
		});

		function getActiveCurrentPage() {
			return parseInt($('li.page-item.active').text().trim())
		}

		// search by text
		let searchTimeout = null;

		// document.getElementById('searchInput').addEventListener('keyup', function() {
		$(document).on('keyup', '#searchInput', function () {
			clearTimeout(searchTimeout);  // Clear the previous timeout

			searchTimeout = setTimeout(function () {
				// User has stopped typing, send AJAX request
				let currentPage = getActiveCurrentPage() || 1;
				loadPage(currentPage, load_page_url);
			}, 1000);  // 1 second delay
		});

		// sort based on click on headers 
		$(document).on('click', 'a[data-sort-field]', function () {
			event.preventDefault();
			let sortField = $(this).data('sort-field');
			updateSortingPreferences(sortField)
			let currentPage = getActiveCurrentPage() || 1;
			loadPage(currentPage, load_page_url);
		});

		function updateSortingPreferences(fieldName) {
			app_name = "{{ segment }}"
			$.ajax({
				url: "{% url 'update_sort_order' %}",
				type: 'POST',
				data: {
					'app_name': app_name,
					'field_name': fieldName,
					'csrfmiddlewaretoken': '{{ csrf_token }}'
				},
				success: function (response) {
					if (response.status === 'success') {
						console.log('Sorting preferences updated');
					}
				}
			});
		}

		// sort based on click on headers
		function updateSortHeaders() {
			app_name = "{{ segment }}"
			$.ajax({
				url: "{% url 'get_sort_order' %}",
				type: 'GET',
				data: {
					'app_name': app_name,
				},
				success: function (response) {
					if (response.status === 'success' && response.result != undefined) {
						$('a[data-sort-field]').each(function () {
							var sortField = $(this).data('sort-field');
							var sortDirection = response.result[sortField]
							if (sortDirection == undefined) {
								$(this).removeClass('text-primary');
								$(this).removeClass('sorted-asc');
								$(this).removeClass('sorted-desc');
							} else if (sortDirection == "asc") {
								$(this).addClass('text-primary');
								$(this).addClass('sorted-asc').removeClass('sorted-desc');
							} else if (sortDirection == "desc") {
								$(this).addClass('text-primary');
								$(this).addClass('sorted-desc').removeClass('sorted-asc');
							}
						});
					}
				}
			});
			return undefined
		}

		// Date picker
		$("#from_date, #to_date").on("change", function () {

			$("#close-search-by-date").css("display", "flex")

			// values from from date and to date is implemented in loadPage function

			// Perform your action here, e.g., trigger a search or filter based on the selected date range
			let currentPage = getActiveCurrentPage() || 1;
			loadPage(currentPage, load_page_url, "-created_at", "asc");
		});

		// Date picker
		$("#close-search-by-date").on("click", function () {
			$("#from_date, #to_date").val('')
			$("#close-search-by-date").css("display", "none")
			let currentPage = getActiveCurrentPage() || 1;
			loadPage(currentPage, load_page_url);
		});

		async function removeItem(item_id, url, reloadAfterSuccess = false) {

			await $.ajax({
				url: url,
				method: 'POST',
				data: {
					item_id: item_id,
					csrfmiddlewaretoken: '{{ csrf_token }}'  // Include the CSRF token for security
				},
				dataType: 'json',
				success: function (response) {
					if (response.success) {
						if (!reloadAfterSuccess) {
							window.location.href = load_page_url
						}
					} else if (response.error) {
						showAlert('error', 'خطا', response.error);
					}
					else {
						showAlert('error', 'خطا', 'حذف انجام نشد');
					}
				},
				error: function () {
					// AJAX request failed, handle the error or show an error message
					showAlert('error', 'خطا', 'خطا نامشخصی رخ داد لطفا بعد از بازنشانی صفحه دوباره امتحان کنید');
				}
			});
		}

		if (typeof remove_rul !== 'undefined') {
			$('#remove_btn').on('click', function () {
				showQuestionAlert("آیا از حذف مطمئن هستید؟", "این عملیات غیرقابل بازگشت می باشد", "حذف می کنم", "بیخیال")
					.then((result) => {
						if (result.isConfirmed && remove_rul != 'undefined') {
							removeItem(item_id, remove_rul)
						}
					})
			});
			$(document).on('click', '[name="menu_remove_item"]', function (event) {
				event.preventDefault()
				showQuestionAlert("آیا از حذف مطمئن هستید؟", "این عملیات غیرقابل بازگشت می باشد", "حذف می کنم", "بیخیال")
					.then((result) => {
						if (result.isConfirmed) {
							let id = $(this).data('id')
							removeItem(id, remove_rul)
						}
					})
			});
		}

	});

</script>